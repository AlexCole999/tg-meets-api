const express = require('express');
const router = express.Router();
const SingleMeet = require('../models/SingleMeet');
const User = require('../models/User');
const bot = require('../bot'); // üëà —Ç–≤–æ–π telegraf-–±–æ—Ç, –∏–º–ø–æ—Ä—Ç–∏—Ä—É–π –∫–∞–∫ –Ω–∞–¥–æ

router.post('/single/create', async (req, res) => {
  const {
    telegramId,
    gender,
    time,
    location,
    minAge,
    maxAge,
    minWeight,
    maxWeight,
  } = req.body;

  if (!telegramId || !time || !location) {
    return res.json({ error: '‚õî –¢—Ä–µ–±—É—é—Ç—Å—è telegramId, time –∏ location' });
  }

  const existingMeet = await SingleMeet.findOne({
    creator: telegramId,
    status: 'open',
  });

  if (existingMeet) {
    return res.json({ error: '‚õî –£ –≤–∞—Å —É–∂–µ –µ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω–∞—è –≤—Å—Ç—Ä–µ—á–∞' });
  }

  try {
    const meet = await SingleMeet.create({
      creator: telegramId,
      gender,
      time,
      location,
      minAge,
      maxAge,
      minWeight,
      maxWeight,
    });

    res.json({ status: '‚úÖ –í—Å—Ç—Ä–µ—á–∞ —Å–æ–∑–¥–∞–Ω–∞', meet });
  } catch (err) {
    console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –≤—Å—Ç—Ä–µ—á–∏:', err);
    res.status(500).send('‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞');
  }
});

router.post('/single/apply', async (req, res) => {
  const { meetingId, telegramId } = req.body;

  if (!meetingId || !telegramId) {
    return res.json({ error: '‚õî –ù—É–∂–Ω—ã meetingId –∏ telegramId' });
  }

  try {
    const meet = await SingleMeet.findById(meetingId);
    if (!meet) {
      return res.json({ error: '‚õî –í—Å—Ç—Ä–µ—á–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞' });
    }

    if (String(meet.creator) === String(telegramId)) {
      return res.json({ error: '‚õî –ù–µ–ª—å–∑—è –æ—Ç–∫–ª–∏–∫–Ω—É—Ç—å—Å—è –Ω–∞ —Å–≤–æ—é –≤—Å—Ç—Ä–µ—á—É' });
    }

    const alreadyCandidate = meet.candidates.some(
      (c) => String(c.telegramId) === String(telegramId)
    );

    if (alreadyCandidate) {
      return res.json({ error: '‚õî –í—ã —É–∂–µ –æ—Ç–∫–ª–∏–∫–Ω—É–ª–∏—Å—å –Ω–∞ —ç—Ç—É –≤—Å—Ç—Ä–µ—á—É' });
    }

    // –î–æ–±–∞–≤–ª—è–µ–º –≤ –∫–∞–Ω–¥–∏–¥–∞—Ç—ã
    meet.candidates.push({
      telegramId: String(telegramId),
      status: 'pending',
    });

    await meet.save();

    const user = await User.findOne({ telegramId });
    const name = user?.name || '–ë–µ–∑ –∏–º–µ–Ω–∏';

    await bot.telegram.sendMessage(
      meet.creator,
      `üë§ ${name} (${telegramId}) —Ö–æ—á–µ—Ç —É—á–∞—Å—Ç–≤–æ–≤–∞—Ç—å –≤–æ –≤—Å—Ç—Ä–µ—á–µ\nüìç ${meet.location}\nüìÖ ${new Date(meet.time).toLocaleString()}`
    );

    res.json({ status: '‚úÖ –ó–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞' });
  } catch (err) {
    console.error('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è:', err);
    res.json({ error: '‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ' });
  }
});

// router.get('/single/all', async (req, res) => {
//   try {
//     const { gender, minAge, maxAge } = req.query;

//     const query = { status: 'open' };

//     // —Ñ–∏–ª—å—Ç—Ä –ø–æ –ø–æ–ª—É
//     if (gender && gender !== 'any') {
//       query.gender = { $in: [gender, 'any'] };
//     }

//     // —Ñ–∏–ª—å—Ç—Ä –ø–æ –≤–æ–∑—Ä–∞—Å—Ç—É: –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–µ –¥–∏–∞–ø–∞–∑–æ–Ω–æ–≤
//     if (minAge) {
//       query.maxAge = { $gte: Number(minAge) };
//     }
//     if (maxAge) {
//       query.minAge = { $lte: Number(maxAge) };
//     }

//     console.log('üì• –§–∏–ª—å—Ç—Ä:', query);

//     const meets = await SingleMeet.find(query).sort({ time: 1 });

//     const creatorIds = meets.map(m => m.creator);
//     const creators = await User.find({ telegramId: { $in: creatorIds } });
//     const creatorMap = Object.fromEntries(creators.map(u => [u.telegramId, u.toObject()]));

//     const result = meets.map(m => ({
//       ...m.toObject(),
//       creatorProfile: creatorMap[m.creator] || null,
//     }));

//     res.json(result);
//   } catch (err) {
//     console.error('‚ùå –û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞ –≤—Å—Ç—Ä–µ—á:', err);
//     res.status(500).json({ error: '‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
//   }
// });

router.get('/single/all', async (req, res) => {
  try {
    const { gender, minAge, maxAge } = req.query;

    const query = { status: 'open' };

    // ‚úÖ —Ñ–∏–ª—å—Ç—Ä –ø–æ –ø–æ–ª—É
    if (gender && gender !== 'any') {
      query.gender = { $in: [gender, 'any'] };
    }

    // ‚úÖ —Ñ–∏–ª—å—Ç—Ä –ø–æ –≤–æ–∑—Ä–∞—Å—Ç—É
    // –µ—Å–ª–∏ –ø–µ—Ä–µ–¥–∞–Ω —Ç–æ–ª—å–∫–æ minAge ‚Äì –∏—â–µ–º –≤—Å—Ç—Ä–µ—á–∏, –≥–¥–µ –≤–µ—Ä—Ö–Ω—è—è –≥—Ä–∞–Ω–∏—Ü–∞ >= minAge –∏–ª–∏ –≥—Ä–∞–Ω–∏—Ü—ã –Ω–µ—Ç
    if (minAge) {
      query.$or = [
        { maxAge: null },
        { maxAge: { $gte: Number(minAge) } }
      ];
    }

    // –µ—Å–ª–∏ –ø–µ—Ä–µ–¥–∞–Ω —Ç–æ–ª—å–∫–æ maxAge ‚Äì –∏—â–µ–º –≤—Å—Ç—Ä–µ—á–∏, –≥–¥–µ –Ω–∏–∂–Ω—è—è –≥—Ä–∞–Ω–∏—Ü–∞ <= maxAge –∏–ª–∏ –≥—Ä–∞–Ω–∏—Ü—ã –Ω–µ—Ç
    if (maxAge) {
      // –µ—Å–ª–∏ —É–∂–µ –µ—Å—Ç—å $or –æ—Ç minAge ‚Äì –Ω–∞–¥–æ —Å–æ–≤–º–µ—Å—Ç–∏—Ç—å —á–µ—Ä–µ–∑ $and
      if (query.$or) {
        query.$and = [
          { $or: query.$or },
          {
            $or: [
              { minAge: null },
              { minAge: { $lte: Number(maxAge) } }
            ]
          }
        ];
        delete query.$or; // —É–±–∏—Ä–∞–µ–º $or –Ω–∞ –≤–µ—Ä—Ö–Ω–µ–º —É—Ä–æ–≤–Ω–µ
      } else {
        query.$or = [
          { minAge: null },
          { minAge: { $lte: Number(maxAge) } }
        ];
      }
    }

    console.log('üì• –ò—Ç–æ–≥–æ–≤—ã–π —Ñ–∏–ª—å—Ç—Ä:', JSON.stringify(query, null, 2));

    const meets = await SingleMeet.find(query).sort({ time: 1 });

    // üë§ –ø–æ–¥–≥—Ä—É–∂–∞–µ–º –ø—Ä–æ—Ñ–∏–ª–∏ —Å–æ–∑–¥–∞—Ç–µ–ª–µ–π
    const creatorIds = meets.map(m => m.creator);
    const creators = await User.find({ telegramId: { $in: creatorIds } });
    const creatorMap = Object.fromEntries(creators.map(u => [u.telegramId, u.toObject()]));

    const result = meets.map(m => ({
      ...m.toObject(),
      creatorProfile: creatorMap[m.creator] || null,
    }));

    res.json(result);
  } catch (err) {
    console.error('‚ùå –û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞ –≤—Å—Ç—Ä–µ—á:', err);
    res.status(500).json({ error: '‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
  }
});



module.exports = router;
